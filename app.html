<!DOCTYPE html>
<html lang="">
<head>
	<meta charset="UTF-8">
	<title>Book a room</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" type="text/css" href="assets/icons/style.css">
</head>

<body>
	<div class="wrapper">
		<h3>What would you like?</h3>
		<span class="mic-icon icon-uniE600"></span>
		<textarea id="what-i-say" type="text" rows="1"></textarea>
		<div id="what-i-think">
			<section id="action">
				<h3>You want to</h3>
				<p>&nbsp;</p>
			</section>
			<section id="timeString">
				<h3>When</h3>
				<p>&nbsp;</p>
			</section>
			<section id="people">
				<h3>For how many people</h3>
				<p>&nbsp;</p>
			</section>
			<section id="devices">
				<h3>With these devices</h3>
				<p>&nbsp;</p>
			</section>
		</div>
		<div id="what-i-have">
			<h3>I have these rooms for you </h3>
			<ul>
				<!-- <li data-id="room-1"><img src="assets/room_1.jpg" /><span>ad hoc G-1</span></li>
				<li data-id="room-2"><img src="assets/room_2.jpg" /><span>Executive Conference Room</span></li>
				<li data-id="room-3"><img src="assets/room_1.jpg" /><span>ad hoc G-1</span></li>
				<li data-id="room-4"><img src="assets/room_2.jpg" /><span>Executive Conference Room</span></li>
				<li data-id="room-5"><img src="assets/room_1.jpg" /><span>ad hoc G-1</span></li>
				<li data-id="room-6"><img src="assets/room_2.jpg" /><span>Executive Conference Room</span></li>
				<li data-id="room-7"><img src="assets/room_1.jpg" /><span>ad hoc G-1</span></li>
				<li data-id="room-8"><img src="assets/room_1.jpg" /><span>ad hoc G-1</span></li>
				<li data-id="room-9"><img src="assets/room_2.jpg" /><span>Executive Conference Room</span></li>
				<li data-id="room-10"><img src="assets/room_2.jpg" /><span>Executive Conference Room</span></li>
				<li data-id="room-11"><img src="assets/room_1.jpg" /><span>ad hoc G-1</span></li>
				<li data-id="room-12"><img src="assets/room_2.jpg" /><span>Executive Conference Room</span></li>
				<li data-id="room-13"><img src="assets/room_1.jpg" /><span>ad hoc G-1</span></li>
				<li data-id="room-14"><img src="assets/room_2.jpg" /><span>Executive Conference Room</span></li> -->
			</ul>
		</div>
	</div>
	
</body>
</html>
<script src="jquery-1.10.1.min.js"></script>
<script src="jquery-ui-1.10.3.custom.min.js"></script>
<script src="sugar.min.js"></script>
<script src="data.js"></script>
<script src="speech.js"></script>
<script src="think.js"></script>
<script>
$(document).ready(function(e){	
	var think = module.getIntent;
	var prevUserIntent = {};
	var prevUserSay = '';

	$('#what-i-say').focus();

	injectRooms();

	function injectRooms(){
		$('#what-i-have ul').empty();
		for(i in Room.MeetingRooms){
			var r = Room.MeetingRooms[i];
			$('#what-i-have ul').append('<li data-id="room-{name}"><img src="assets/room_{name}.jpg" /><span>{title}, on {floor} floor, capacity: {capacity}</span></li>'
				.assign({name: r.name.dasherize(), title: r.name, floor: parseInt(r.floor) == 1 ? '1st' : '2nd', capacity: r.capacity}))
		}
	}

	toggle();

	function toggle(){
		$('#what-i-think section').each(function(index, item){
			if($(this).find('p').text().trim() === ''){
				$(this).addClass('hidden');
			}
			else{
				$(this).removeClass('hidden');
			}
		});	
	}
	

	setInterval(function(){		
		var s = $('#what-i-say').val();

		//if the text has changed
		if(s != prevUserSay){
			resize();
			var userIntent = think(s.endsWith(' ') ? s : s + ' ');	//sometimes it requires a additional ' ' to recognize time
			onthefly(userIntent);			
			prevUserIntent = userIntent;	
			prevUserSay = s;	
			var room = module.getRoom(userIntent);
			var room_id = 'room-' + (room.name||'').dasherize();
			$('#what-i-have li:not([data-id="' + room_id + '"])').hide();
			$('#what-i-have li[data-id="' + room_id + '"]').show();
			console.log(room);
			console.log('updated HMI');
			toggle();
		}		
	}, 500);

	

	var resize = function(){
		window.setTimeout(function(){
			console.log('scrollHeight: ' +  $('#what-i-say').prop('scrollHeight') + 'px');
			$('#what-i-say').css('height', 'auto');
			$('#what-i-say').css('height', $('#what-i-say').prop('scrollHeight') + 'px');
		}, 0);	
	}

	$('#what-i-say').on('keyup', resize);
	$(window).on('resize', resize);

	function onthefly(userIntent){
		$wit = $('#what-i-think');
		var changed = false;
		for(k in userIntent){
			var uiprop = (userIntent[k] + '').trim(), 
			puiprop = (prevUserIntent[k] + '').trim();
			if(uiprop != puiprop){
				console.log(uiprop + '---' + puiprop);
				$wit.find('#' + k + ' p').html(uiprop).effect('bounce', 'slow');			
				changed = true;
			}
		}
		if(changed){
			speakUserIntent(userIntent);
		}
	}

	var justSpoken = false;
	var confirmUserIntent = null;

	function speakUserIntent(userIntent){
		if(!justSpoken){
			var str = 'You want to {action} a meeting room {timeString} for {people} participants with {devices}. '
			.assign({action: userIntent.action, timeString: userIntent.timeString, people: userIntent.people, devices: (userIntent.devices || []).length == 0 ? 'no special device' : userIntent.devices.join(', ')});
			var msg = new SpeechSynthesisUtterance(str);
			var confirm = new SpeechSynthesisUtterance('Is this correct?');
			$(document).trigger('confirming');
			window.speechSynthesis.speak(msg);			
			setTimeout(function(){window.speechSynthesis.speak(confirm);}, 500);

			confirmUserIntent = userIntent;
			justSpoken = true;
			setTimeout(function(){justSpoken = false;}, 10000);
		}		
	}

	$(document).on('yes', function(e){
		console.log(e, 'yes');
		var ok = new SpeechSynthesisUtterance('OK, let me look it up. ');
		window.speechSynthesis.speak(ok);
	});



});
</script>