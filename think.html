<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
  <title></title>
  <style>
  	input[type='text']{
  		width: 320px;
  	}
  </style>
</head>

<body>
  <input id="what-i-say" type="text" value="book a meeting room at 2 pm tomorrow with a projector" />
  <button id="go-figure">Go figure</button>
  <div id="what-i-think"></div>
</body>
</html>
<script src="jquery-1.10.1.min.js"></script>
<script type="text/javascript" src="sugar.min.js"></script>
<script>
    $(document).ready(function(){
    	function UserIntent(speech, action, people, devices, time){
    		this.speech = speech;
    		this.action = action;
    		this.people = people;
    		this.devices = devices || [];
    		this.time = time;
    	}

    	function Analyzer(rawString, words){
    		this.rawString = rawString || '';
    		this.words = words || [];
    	}

    	function DateTime(rawString){
    		this.rawString = rawString;

    		this.WEEKDAYS = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    		this.RELATIVE = ['last', 'next', 'this'];
    		this.DAYS = ['today', 'tomorrow'];
    		this.AP = ['a.m.', 'p.m.', 'am', 'pm'];

    		var regex = new RegExp('((?:tomorrow|today)\\s*[a-z]*\\s*\\d+(?:am|pm))|(\\d+\\s*(?:am|pm)\\s*(?:tomorrow|today|[a-z]+\\sday after tomorrow))|((?:last|next|this)\\s*(?:' + this.WEEKDAYS.join('|') + ')\\s*[a-z]*\\s*\\d+(?:am|pm|))|(\\d+\\s*(?:am|pm)\\s*[^\r]*(?:next|this|last)\\s*(?:' + this.WEEKDAYS.join('|') + '))', 'gi');

    		matched = rawString.toLowerCase().match(regex);
    		matchedString = matched.length > 0 ? matched[0] : null;

    		return Date.create(matchedString);
    	}

    	

    	
    	//-----Preposition class-----
    	function Preposition(){
    		this.PREPOSITIONS = ['at', 'on', 'with', 'between'];    		
    	}
    	
    	Preposition.prototype.search = function(here){
    		var found = [];

    		if(typeof here === 'string'){
    			here = here.split(' ');
    		}
    		
    		for (var i in here){
    			i = parseInt(i);
    			if(this.PREPOSITIONS.indexOf(here[i]) !== -1){
    				found.push({index: i, prep: here[i]});
    			}
    		}

    		return found;
    	}

    	Analyzer.prototype.getIntent = function(){
    		var rs = this.rawString.toLowerCase();
    		this.words = rs.split(' ');

    		var preps = new Preposition().search(this.words);
    		console.log(preps);

    		var fragments = [];
    		for (var i in preps){
    			i = parseInt(i);
    			var fr_startIndex = preps[i].index + 1;
    			var fr_endIndex = preps[i + 1] ? preps[i + 1].index : this.words.length;
    			fr_words = this.words.slice(fr_startIndex, fr_endIndex); //not f_words...
    			fragments.push({prep: preps[i], words: fr_words});
    		}
    		console.log(fragments, 'fragments');

			var intent = new UserIntent(rs);
    		if(this.words.indexOf('book') !== -1){
    			intent.action = 'book';
    		}
    		if(this.words.indexOf('projector') !== -1){
    			intent.devices.push('projector');
    		}

    		intent.time = new DateTime(rs);

    		return intent;    		
    	}

    	//var myIntent = new UserIntent('create', 12, 'projector whiteboard', '2014-06-12 14:55:00');
		$('#go-figure').on('click', function(e){
			var analyzer = new Analyzer($('#what-i-say').val());
		    var myIntent = analyzer.getIntent();    

		    console.log(analyzer);
    		console.log(myIntent);

		});    	
    });
</script>